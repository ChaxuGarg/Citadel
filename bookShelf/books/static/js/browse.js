// DB = {"CO": {"COL333": {"Books": {"AI-search.pdf": "/media/database/CO/COL333/Books/AI-search.pdf", "AIMA 3ed. - Solution Manual.pdf": "/media/database/CO/COL333/Books/AIMA 3ed. - Solution Manual.pdf", "AI_Elaine_Rich_Kevin_Knight.pdf": "/media/database/CO/COL333/Books/AI_Elaine_Rich_Kevin_Knight.pdf", "Artificial Intelligence A Modern Approach (3rd Edition).pdf": "/media/database/CO/COL333/Books/Artificial Intelligence A Modern Approach (3rd Edition).pdf", "COL333_2016-17_sem1_Book_nameartificial_intelligence.pdf": "/media/database/CO/COL333/Books/COL333_2016-17_sem1_Book_nameartificial_intelligence.pdf"}, "Professors": {"mausam": {"Assignments": {"A1.pdf": "/media/database/CO/COL333/Professors/mausam/Assignments/A1.pdf", "A1.zip": "/media/database/CO/COL333/Professors/mausam/Assignments/A1.zip", "A2.pdf": "/media/database/CO/COL333/Professors/mausam/Assignments/A2.pdf", "A3.pdf": "/media/database/CO/COL333/Professors/mausam/Assignments/A3.pdf", "A4.pdf": "/media/database/CO/COL333/Professors/mausam/Assignments/A4.pdf", "A5.pdf": "/media/database/CO/COL333/Professors/mausam/Assignments/A5.pdf"}, "Lectures": {"01-intro.pdf": "/media/database/CO/COL333/Professors/mausam/Lectures/01-intro.pdf", "02-search.pdf": "/media/database/CO/COL333/Professors/mausam/Lectures/02-search.pdf", "03-hsearch.pdf": "/media/database/CO/COL333/Professors/mausam/Lectures/03-hsearch.pdf", "04-lsearch.pdf": "/media/database/CO/COL333/Professors/mausam/Lectures/04-lsearch.pdf", "05-csp.pdf": "/media/database/CO/COL333/Professors/mausam/Lectures/05-csp.pdf", "06-logic.pdf": "/media/database/CO/COL333/Professors/mausam/Lectures/06-logic.pdf", "07-games.pdf": "/media/database/CO/COL333/Professors/mausam/Lectures/07-games.pdf", "08-decisiontheory.pdf": "/media/database/CO/COL333/Professors/mausam/Lectures/08-decisiontheory.pdf", "09-mdp.pdf": "/media/database/CO/COL333/Professors/mausam/Lectures/09-mdp.pdf", "10-pomdp.pdf": "/media/database/CO/COL333/Professors/mausam/Lectures/10-pomdp.pdf", "11-lao.pdf": "/media/database/CO/COL333/Professors/mausam/Lectures/11-lao.pdf", "12-mcts.pdf": "/media/database/CO/COL333/Professors/mausam/Lectures/12-mcts.pdf", "13-rl.pdf": "/media/database/CO/COL333/Professors/mausam/Lectures/13-rl.pdf", "14-uncertainty.pdf": "/media/database/CO/COL333/Professors/mausam/Lectures/14-uncertainty.pdf", "15-bayesnets.pdf": "/media/database/CO/COL333/Professors/mausam/Lectures/15-bayesnets.pdf", "16-bayesnetapprox.pdf": "/media/database/CO/COL333/Professors/mausam/Lectures/16-bayesnetapprox.pdf", "17-bayesnetlearning.pdf": "/media/database/CO/COL333/Professors/mausam/Lectures/17-bayesnetlearning.pdf", "18-wrapup.pdf": "/media/database/CO/COL333/Professors/mausam/Lectures/18-wrapup.pdf"}}, "saroj": {"Lectures": {"L10_Partial_Planning_Constraint_Posting.pdf": "/media/database/CO/COL333/Professors/saroj/Lectures/L10_Partial_Planning_Constraint_Posting.pdf", "L11_Prolog.pdf": "/media/database/CO/COL333/Professors/saroj/Lectures/L11_Prolog.pdf", "L12_Adv Prolog.pdf": "/media/database/CO/COL333/Professors/saroj/Lectures/L12_Adv Prolog.pdf", "L13_Logic Concepts.pdf": "/media/database/CO/COL333/Professors/saroj/Lectures/L13_Logic Concepts.pdf", "L14_Predicate Logic.pdf": "/media/database/CO/COL333/Professors/saroj/Lectures/L14_Predicate Logic.pdf", "L15_Knowledge Rep.pdf": "/media/database/CO/COL333/Professors/saroj/Lectures/L15_Knowledge Rep.pdf", "L16_Conceptual dependency.pdf": "/media/database/CO/COL333/Professors/saroj/Lectures/L16_Conceptual dependency.pdf", "L17_KR_NL.pdf": "/media/database/CO/COL333/Professors/saroj/Lectures/L17_KR_NL.pdf", "L18_Expert System.pdf": "/media/database/CO/COL333/Professors/saroj/Lectures/L18_Expert System.pdf", "L19-MDP.pdf": "/media/database/CO/COL333/Professors/saroj/Lectures/L19-MDP.pdf", "L1_Introduction.pdf": "/media/database/CO/COL333/Professors/saroj/Lectures/L1_Introduction.pdf", "L20-Fuzzy.pdf": "/media/database/CO/COL333/Professors/saroj/Lectures/L20-Fuzzy.pdf", "L21_FIS.pdf": "/media/database/CO/COL333/Professors/saroj/Lectures/L21_FIS.pdf", "L22_Fuzzy Inferencing.pdf": "/media/database/CO/COL333/Professors/saroj/Lectures/L22_Fuzzy Inferencing.pdf", "L23_Certainty_Measure.pdf": "/media/database/CO/COL333/Professors/saroj/Lectures/L23_Certainty_Measure.pdf", "L24_Bayesian_Belief_Network.pdf": "/media/database/CO/COL333/Professors/saroj/Lectures/L24_Bayesian_Belief_Network.pdf", "L25_Dempster Theory.pdf": "/media/database/CO/COL333/Professors/saroj/Lectures/L25_Dempster Theory.pdf", "L26_Enhancement of Logic.pdf": "/media/database/CO/COL333/Professors/saroj/Lectures/L26_Enhancement of Logic.pdf", "L27_ANN.pdf": "/media/database/CO/COL333/Professors/saroj/Lectures/L27_ANN.pdf", "L28_Recurrent_radialNN.pdf": "/media/database/CO/COL333/Professors/saroj/Lectures/L28_Recurrent_radialNN.pdf", "L29_Machine_Learning.pdf": "/media/database/CO/COL333/Professors/saroj/Lectures/L29_Machine_Learning.pdf", "L2_Tic_Tac_Toe.pdf": "/media/database/CO/COL333/Professors/saroj/Lectures/L2_Tic_Tac_Toe.pdf", "L3_Problem_solving.pdf": "/media/database/CO/COL333/Professors/saroj/Lectures/L3_Problem_solving.pdf", "L4_Search_Strategies.pdf": "/media/database/CO/COL333/Professors/saroj/Lectures/L4_Search_Strategies.pdf", "L5_Heuristic_Searches.pdf": "/media/database/CO/COL333/Professors/saroj/Lectures/L5_Heuristic_Searches.pdf", "L6_Constraint_Satisfaction.pdf": "/media/database/CO/COL333/Professors/saroj/Lectures/L6_Constraint_Satisfaction.pdf", "L7_Game_Playing.pdf": "/media/database/CO/COL333/Professors/saroj/Lectures/L7_Game_Playing.pdf", "L8_Planning.pdf": "/media/database/CO/COL333/Professors/saroj/Lectures/L8_Planning.pdf", "L9_NL_Planning.pdf": "/media/database/CO/COL333/Professors/saroj/Lectures/L9_NL_Planning.pdf", "nohup.out": "/media/database/CO/COL333/Professors/saroj/Lectures/nohup.out"}}}}, "COL702": {"Books": {"temp.txt": "/media/database/CO/COL702/Books/temp.txt"}}, "COL703": {"Professors": {"sak": {"Assignments": {"Assignment 1.pdf": "/media/database/CO/COL703/Professors/sak/Assignments/Assignment 1.pdf", "Assignment 2.pdf": "/media/database/CO/COL703/Professors/sak/Assignments/Assignment 2.pdf", "Assignment_3.pdf": "/media/database/CO/COL703/Professors/sak/Assignments/Assignment_3.pdf"}, "backup": {"SAK_Slides_2017-08-29.pdf": "/media/database/CO/COL703/Professors/sak/backup/SAK_Slides_2017-08-29.pdf", "SAK_Slides_2017-09-19.pdf": "/media/database/CO/COL703/Professors/sak/backup/SAK_Slides_2017-09-19.pdf", "SAK_Slides_2017-09-25.pdf": "/media/database/CO/COL703/Professors/sak/backup/SAK_Slides_2017-09-25.pdf", "SAK_Slides_2017-09-26.pdf": "/media/database/CO/COL703/Professors/sak/backup/SAK_Slides_2017-09-26.pdf", "SAK_Slides_2017-10-06.pdf": "/media/database/CO/COL703/Professors/sak/backup/SAK_Slides_2017-10-06.pdf", "SAK_Slides_2017-10-31.pdf": "/media/database/CO/COL703/Professors/sak/backup/SAK_Slides_2017-10-31.pdf"}}}}}, "HU": {"HUL212": {"Books": {"Intermediate_Microeconomics_A_Modern_Approach_7th_ed_Hal_R_Varian.pdf": "/media/database/HU/HUL212/Books/Intermediate_Microeconomics_A_Modern_Approach_7th_ed_Hal_R_Varian.pdf", "Mas-Colell&Whinston&Green -- Microeconomic Theory.pdf": "/media/database/HU/HUL212/Books/Mas-Colell&Whinston&Green -- Microeconomic Theory.pdf", "Varian_Workbook.pdf": "/media/database/HU/HUL212/Books/Varian_Workbook.pdf", "microeconomic analysis 3d hal varian.pdf": "/media/database/HU/HUL212/Books/microeconomic analysis 3d hal varian.pdf"}, "Professors": {"mondal": {"Answer key minor 1 hul 212 2017.pdf": "/media/database/HU/HUL212/Professors/mondal/Answer key minor 1 hul 212 2017.pdf", "HUL212_2017-18_sem1_Notes.pdf": "/media/database/HU/HUL212/Professors/mondal/HUL212_2017-18_sem1_Notes.pdf", "New Doc 2017-09-27 (1).pdf": "/media/database/HU/HUL212/Professors/mondal/New Doc 2017-09-27 (1).pdf", "Notes_M1.pdf": "/media/database/HU/HUL212/Professors/mondal/Notes_M1.pdf", "Problem set HUL212.pdf": "/media/database/HU/HUL212/Professors/mondal/Problem set HUL212.pdf"}}}}}
DB = {}

var COLS = [];

var PATH_ELEM = $("#path-bar")[0];
var COLS_ELEM = $("#file-browser")[0];
var MEDIA_PREFIX = "/media/database/";
var API_URL = "/books/api/structure";

// creates single pathbar navigation element
function create_elem_path(name,url)
{
    var html = '<li class="breadcrumb-item"><a href="'+url+'">'+name+'</a></li>';
    return $.parseHTML(html)[0];
}

// creates the base div block which contains a pane of file browser
function create_base_div_col()
{
    var html = '<div class="list-group file-column"></div>';
    return $.parseHTML(html)[0];
}

// removes all the columns in the COLS array except the first num_cols_retain 
function remove_cols(num_cols_retain)
{
    for(var i=num_cols_retain;i<COLS.length;i++)
    {
        COLS[i].remove();
    }
    COLS = COLS.slice(0,num_cols_retain);
}

// updates the current file browser view according to the path prefix given
function update_view(path_prefix)
{
    // number of columns to retain
    var num_cols = path_prefix.length;
    
    // removing the un-needed columns
    remove_cols(num_cols);

    // removing active status from all the elements in last column
    $(COLS[COLS.length-1]).children().removeClass("active");

    // creating column corresponding to the clicked folder
    var new_column = create_column(path_prefix.slice());

    // adding column to the html of the page
    COLS_ELEM.append(new_column);

    // saving the column object in COLS array
    COLS.push(new_column);

    // redrawing the path bar
    redraw_path_bar(path_prefix);

    // scroll this new column into view
    new_column.scrollIntoView();
}

// returns the event handler to be called when an element is clicked in file column
function get_event_handler_col(is_file,path_prefix,url)
{
    if(is_file)
    {
        return function(){var win = window.open(url,'_blank');win.focus();};
    }
    else
    {
        return function()
        {
            update_view(path_prefix.slice());
            $(this).addClass("active");
        };
    }
}

// create an entry for the div block of column of file viewer
// also add necessary event listener
function create_elem_col(path_prefix,name,is_file)
{
    var new_id = "";
    for(var i=0;i<path_prefix.length;i++)
    {
        new_id += path_prefix[i][0]+"/";
    }
    new_id += name+"/";

    path_prefix.push([name,"#"+new_id]);

    var html = '<a href="#" class="list-group-item list-group-item-action" id="'+new_id+'"><div class="col-item">'+name+'</div></a>';
    var btn = $.parseHTML(html)[0];

    var handler = get_event_handler_col(is_file,path_prefix.slice(),MEDIA_PREFIX+new_id);
    
    btn.onclick = handler;

    return btn;
}

// redraws the path bar according to the value in PATH array
function redraw_path_bar(path)
{
    //reset the current html
    PATH_ELEM.innerHTML="";

    //add the new path
    for(var i=0;i<path.length;i++)
    {
        PATH_ELEM.append(create_elem_path(path[i][0],path[i][1]));
    }
}

// get the dict corresponding to the given path_prefix
function get_prefix_dict(path_prefix)
{
    var db = DB;
    for(var i=0;i<path_prefix.length;i++)
    {
        db = db[path_prefix[i][0]];
    }
    return db;
}

// creates column containing the files according to the path_prefix passed
function create_column(path_prefix)
{
    var base_div = create_base_div_col();
    var folders = []
    var files = []

    var dic = get_prefix_dict(path_prefix)

    for (var key in dic)
    {
        if(dic.hasOwnProperty(key))
        {
            if (dic[key] === undefined)
            {
                // fetch more data
            }
            if(typeof(dic[key])==='string')
            {
                // if file then put in files
                files.push([key,create_elem_col(path_prefix.slice(),key,true)]);
            }
            else
            {
                // put in folder
                folders.push([key,create_elem_col(path_prefix.slice(),key,false)]);
            }
        }
    }

    folders.sort(function(a,b){return (a[0] > b[0]) ? 1 : ((b[0] > a[0]) ? -1 : 0);});
    files.sort(function(a,b){return (a[0] > b[0]) ? 1 : ((b[0] > a[0]) ? -1 : 0);});

    for(var i=0;i<folders.length;i++)
    {
        base_div.append(folders[i][1]);
    }
    for(var i=0;i<files.length;i++)
    {
        base_div.append(files[i][1]);
    }

    return base_div;
}

$(document).ready(function(){
    $.getJSON( API_URL, function( data ) {
        DB=data;
        update_view([]);
        redraw_path_bar([["Home","#"]]);
    });
});
